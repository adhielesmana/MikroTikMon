# Docker Quick Reference

## Build Structure

### Development (Replit)
```
npm run dev
→ tsx server/index.ts (serves both frontend via Vite and backend)
```

### Production (Docker)
```
npm run build
→ vite build              (builds frontend to dist/public/)
→ esbuild server/index.ts (builds backend to dist/index.js)
```

**Output:**
```
dist/
├── index.js           # Backend server
└── public/            # Frontend static files
    ├── index.html
    ├── assets/
    └── ...
```

---

## Quick Start

### 1. Initial Setup
```bash
# Make scripts executable
chmod +x setup.sh deploy.sh

# Run automated setup (generates secure credentials)
./setup.sh

# Deploy the application
./deploy.sh up
```

### 2. Access Application
```
http://localhost:5000
```

---

## Available Commands

```bash
./deploy.sh up              # Start (build + deploy)
./deploy.sh stop            # Stop containers
./deploy.sh restart         # Restart containers
./deploy.sh logs            # View real-time logs
./deploy.sh logs -f         # Follow logs
./deploy.sh status          # Check container status
./deploy.sh update          # Pull latest, rebuild, restart
./deploy.sh backup          # Backup database
./deploy.sh restore <file>  # Restore from backup
./deploy.sh shell           # Open app container shell
./deploy.sh db-shell        # Open PostgreSQL shell
./deploy.sh clean           # Remove everything (WARNING!)
```

### With Nginx Reverse Proxy
```bash
./deploy.sh up --with-nginx
```

---

## Manual Build & Run

### Build Docker Image
```bash
docker build -t mikrotik-monitor:latest .
```

### Run with Docker Compose
```bash
docker-compose up -d
```

### View Logs
```bash
docker-compose logs -f
```

### Stop
```bash
docker-compose down
```

---

## Environment Variables

Required variables (auto-generated by `setup.sh`):
- `PGDATABASE` - Database name
- `PGUSER` - Database user
- `PGPASSWORD` - Database password
- `SESSION_SECRET` - Session encryption key

Optional variables:
- `SMTP_HOST` - Email server hostname
- `SMTP_PORT` - Email server port (default: 587)
- `SMTP_USER` - Email username
- `SMTP_PASS` - Email password
- `SMTP_FROM_EMAIL` - From email address

---

## Health Check

The application includes a health check endpoint:

```bash
curl http://localhost:5000/api/health
```

Response:
```json
{
  "status": "ok",
  "timestamp": "2025-11-01T01:34:45.000Z",
  "uptime": 123.45
}
```

Docker automatically monitors this endpoint every 30 seconds.

---

## Database Management

### Backup Database
```bash
./deploy.sh backup
# Creates: backups/mikrotik_monitor_YYYY-MM-DD_HH-MM-SS.sql
```

### Restore Database
```bash
./deploy.sh restore backups/mikrotik_monitor_2025-11-01_12-00-00.sql
```

### Access Database Shell
```bash
./deploy.sh db-shell
# Then run SQL commands:
# \dt          # List tables
# \d users     # Describe users table
# SELECT * FROM users;
```

---

## Troubleshooting

### Container Won't Start
```bash
# Check logs
./deploy.sh logs

# Check container status
docker-compose ps
```

### Database Connection Issues
```bash
# Verify environment variables
docker-compose config

# Check PostgreSQL logs
docker logs mikrotik-monitor-db
```

### Build Issues
```bash
# Clean build
docker-compose down
docker-compose build --no-cache
docker-compose up -d
```

### Reset Everything
```bash
./deploy.sh clean  # Removes all containers and volumes
./setup.sh         # Re-generate credentials
./deploy.sh up     # Fresh start
```

---

## Production Deployment

### 1. VPS Setup (Ubuntu/Debian)
```bash
# Install Docker
curl -fsSL https://get.docker.com -o get-docker.sh
sudo sh get-docker.sh
sudo usermod -aG docker $USER

# Install Docker Compose
sudo apt-get update
sudo apt-get install docker-compose-plugin
```

### 2. Deploy Application
```bash
# Clone repository
git clone <your-repo-url>
cd mikrotik-monitor

# Setup and deploy
./setup.sh
./deploy.sh up --with-nginx
```

### 3. Configure SSL (with Nginx)
```bash
# Install Certbot
sudo apt-get install certbot python3-certbot-nginx

# Get SSL certificate
sudo certbot --nginx -d yourdomain.com

# Auto-renew
sudo crontab -e
# Add: 0 0 * * * certbot renew --quiet
```

### 4. Firewall Setup
```bash
sudo ufw allow 22/tcp    # SSH
sudo ufw allow 80/tcp    # HTTP
sudo ufw allow 443/tcp   # HTTPS
sudo ufw enable
```

---

## File Structure

```
mikrotik-monitor/
├── Dockerfile              # Multi-stage production build
├── docker-compose.yml      # Service orchestration
├── .dockerignore           # Build optimization
├── .env.example            # Environment template
├── .env                    # Your credentials (git-ignored)
├── setup.sh                # Automated setup script
├── deploy.sh               # Deployment automation
├── nginx.conf              # Reverse proxy config
├── init-db.sql             # Database initialization
├── DEPLOYMENT.md           # Full deployment guide
└── DOCKER.md               # This file
```

---

## Security Checklist

- ✅ Non-root container user (nodejs:nodejs)
- ✅ Auto-generated secure passwords (32 chars)
- ✅ No default/weak credentials
- ✅ Environment secrets not in git
- ✅ Health check monitoring
- ✅ Container restart policies
- ✅ Encrypted router credentials in DB
- ✅ SSL/TLS ready with Nginx
- ✅ Regular automated backups

---

## Performance Tuning

### PostgreSQL (docker-compose.yml)
```yaml
environment:
  POSTGRES_MAX_CONNECTIONS: 100
  POSTGRES_SHARED_BUFFERS: 256MB
```

### Application Resources
```yaml
deploy:
  resources:
    limits:
      cpus: '2'
      memory: 2G
    reservations:
      cpus: '0.5'
      memory: 512M
```

---

## Support

For detailed documentation, see:
- **DEPLOYMENT.md** - Comprehensive deployment guide
- **README.md** - Application features and usage
- **replit.md** - Technical architecture

---

**Last Updated:** November 1, 2025
